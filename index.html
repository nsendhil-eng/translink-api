<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Commute Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .suggestion-item:hover { background-color: #bae6fd; }
        .dark .suggestion-item:hover { background-color: #1e40af; }
        .child-stop { border-left: 2px solid #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 py-12 px-4">

    <div class="w-full max-w-2xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white">My Commute</h1>
            <p id="currentTime" class="text-lg text-gray-600 dark:text-gray-400 mt-2"></p>
            <p id="last-updated" class="text-sm text-gray-500 dark:text-gray-400 mt-1"></p>
        </header>
        
        <section class="mb-8">
            <div class="flex flex-col sm:flex-row gap-2 items-center">
                <div class="relative flex-grow w-full">
                    <input type="text" id="stop-search-input" placeholder="Search for a stop (e.g., Wesley)..."
                           class="w-full p-4 bg-white dark:bg-gray-800 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="autocomplete-suggestions" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border rounded-lg shadow-lg hidden"></div>
                </div>
                <button id="find-near-me-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                    <span>Near Me</span>
                </button>
            </div>
            <div id="selected-stops-container" class="mt-3 flex flex-wrap gap-2"></div>
        </section>

        <main id="departures-container" class="space-y-4"></main>
    </div>

    <script>
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
        const VERCEL_URL = 'https://transit.sendhil.com.au';
        const LOCAL_URL = 'http://localhost:3001';
        const BASE_URL = isLocal ? LOCAL_URL : VERCEL_URL;
        const API_ENDPOINT = `${BASE_URL}/api/departures`;
        const findNearMeEndpoint = `${BASE_URL}/api/stops-near-me`;
        const searchStopsEndpoint = `${BASE_URL}/api/search-stops`;
        
        const departuresContainer = document.getElementById('departures-container');
        const currentTimeEl = document.getElementById('currentTime');
        const lastUpdatedEl = document.getElementById('last-updated');
        const searchInput = document.getElementById('stop-search-input');
        const suggestionsContainer = document.getElementById('autocomplete-suggestions');
        const selectedStopsContainer = document.getElementById('selected-stops-container');
        const findNearMeBtn = document.getElementById('find-near-me-btn');

        let ALL_STOPS_DATA = [ 
            { name: 'Auchenflower Station, platform 2', id: '600284', stop_code: '600284' }, 
            { name: 'Auchenflower Station, platform 4', id: '600286', stop_code: '600286' }, 
            { name: 'Auchenflower stop 10/11, Milton Rd', id: '001951', stop_code: '001951' } 
        ];
        let selectedStops = [];
        let searchDebounceTimer;

        function formatBrisbaneTime(utcDateString) {
            if (!utcDateString) return 'N/A';
            const date = new Date(utcDateString);
            return new Intl.DateTimeFormat('en-AU', { hour: 'numeric', minute: 'numeric', hour12: true, timeZone: 'Australia/Brisbane' }).format(date);
        }
        
        function formatTimeRemaining(totalSeconds) {
            if (totalSeconds <= 5) { return 'Now'; }
            if (totalSeconds < 300) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                if (minutes > 0) { return `${minutes} min ${seconds} sec`; }
                return `${seconds} sec`;
            }
            const roundedMinutes = Math.round(totalSeconds / 60);
            return `${roundedMinutes} min`;
        }
        
        async function fetchAndRenderDepartures() {
            let url = API_ENDPOINT;
            if (selectedStops.length > 0) { url += `?stops=${selectedStops.join(',')}`; }

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const allDepartures = await response.json();
                const upcomingDepartures = allDepartures.filter(dep => (dep.secondsUntilDeparture > -60)).slice(0, 10);
                departuresContainer.innerHTML = '';
                lastUpdatedEl.textContent = `Last updated: ${new Date().toLocaleTimeString('en-AU', { hour: 'numeric', minute: '2-digit', second: '2-digit' })}`;

                if (upcomingDepartures.length === 0) {
                    departuresContainer.innerHTML = `<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg text-center"><p class="text-lg font-medium">No upcoming services found.</p></div>`;
                    return;
                }
                upcomingDepartures.forEach(dep => {
                    const card = document.createElement('div');
                    card.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg flex items-start gap-4';
                    const dueInText = formatTimeRemaining(dep.secondsUntilDeparture);
                    const isBus = dep.vehicleType === 'Bus';
                    const iconBgColor = isBus ? 'bg-blue-500' : 'bg-green-600';
                    const iconContent = isBus ? dep.routeNumber : 'üöÜ';
                    const iconHTML = `<div class="flex-shrink-0 ${iconBgColor} text-white w-20 h-20 rounded-lg flex items-center justify-center text-3xl font-bold">${iconContent}</div>`;
                    const destinationHTML = isBus && dep.destinationInfo ? `<p class="text-sm text-gray-600 dark:text-gray-400 mt-1 font-medium">üìç ${dep.destinationInfo}</p>` : '';
                    const scheduledTime = formatBrisbaneTime(dep.scheduledDepartureUtc);
                    const expectedTime = formatBrisbaneTime(dep.expectedDepartureUtc);
                    const expectedHTML = dep.expectedDepartureUtc && (expectedTime !== scheduledTime) ? `<div class="font-semibold text-green-600 dark:text-green-400">Expected: ${expectedTime}</div>` : '';
                    card.innerHTML = `${iconHTML}<div class="flex-grow"><h3 class="text-sm sm:text-lg font-bold">${dep.stopName}</h3>${destinationHTML}</div><div class="text-right flex-shrink-0"><div class="font-semibold text-gray-700 dark:text-gray-300">Scheduled: ${scheduledTime}</div>${expectedHTML}<div class="text-xl font-bold text-blue-600 dark:text-blue-400 mt-1">${dueInText}</div></div>`;
                    departuresContainer.appendChild(card);
                });
            } catch (error) {
                console.error('Failed to fetch departures:', error);
                departuresContainer.innerHTML = `<div class="bg-red-100 p-4 rounded-lg" role="alert"><p class="font-bold">Connection Error</p><p>Could not load data. Ensure the local server is running.</p></div>`;
            }
        }
        
        function updateCurrentTime() {
             const now = new Date();
             currentTimeEl.textContent = now.toLocaleTimeString('en-AU', { weekday: 'long', hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Australia/Brisbane' });
        }
        
        function groupStops(stops) {
            const grouped = new Map();
            const result = [];
            const processedParents = new Set();
            stops.forEach(stop => {
                if (stop.parent_station) {
                    if (!grouped.has(stop.parent_station)) {
                        const parent = { is_parent: true, id: stop.parent_station, name: stop.parent_station_name || 'Station', children: [] };
                        grouped.set(stop.parent_station, parent);
                    }
                    grouped.get(stop.parent_station).children.push(stop);
                }
            });
            stops.forEach(stop => {
                if (stop.parent_station) {
                    if (!processedParents.has(stop.parent_station)) { result.push(grouped.get(stop.parent_station)); processedParents.add(stop.parent_station); }
                } else {
                    if (!grouped.has(stop.id)) { result.push(stop); }
                }
            });
            return result;
        }

        function formatServicingRoutes(routesText, directionsJson) {
            if (!routesText) return 'N/A';
            if (!directionsJson) return routesText;
            return routesText.split(', ').map(route => {
                const directions = directionsJson[route];
                if (directions) {
                    const hasInbound = directions.includes('Inbound');
                    const hasOutbound = directions.includes('Outbound');
                    if (hasInbound && hasOutbound) return `${route}&nbsp;‚Üï`;
                    if (hasInbound) return `${route}&nbsp;‚Üë`;
                    if (hasOutbound) return `${route}&nbsp;‚Üì`;
                }
                return route;
            }).join(', ');
        }

        function renderSelectedStopTags() {
            selectedStopsContainer.innerHTML = '';
            selectedStops.forEach(stopCode => {
                const stop = ALL_STOPS_DATA.find(s => s.stop_code === stopCode);
                if (!stop) return;
                const tag = document.createElement('div');
                tag.className = 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-sm font-semibold px-3 py-1 rounded-full flex items-center gap-2';
                tag.innerHTML = `<span>${stop.name}</span><button data-code="${stop.stop_code}" class="remove-tag-btn font-bold">√ó</button>`;
                selectedStopsContainer.appendChild(tag);
            });
        }

        function renderSuggestions(stops) {
            stops.forEach(stop => {
                if (!ALL_STOPS_DATA.some(s => s.id === stop.id)) { ALL_STOPS_DATA.push(stop); }
            });
            const groupedStops = groupStops(stops);
            suggestionsContainer.innerHTML = '';
            if (groupedStops.length > 0) {
                groupedStops.forEach(item => {
                    if (item.is_parent) {
                        const groupEl = document.createElement('div');
                        groupEl.className = 'border-b dark:border-gray-700';
                        groupEl.innerHTML = `<div class="flex justify-between items-center cursor-pointer parent-toggle p-3"><div class="font-bold">${item.name}</div><div class="text-blue-500 font-bold text-lg expand-icon">+</div></div><div class="pl-4 hidden child-container">${item.children.map(child => `<div class="p-2 cursor-pointer suggestion-item child-stop" data-id="${child.id}" data-code="${child.stop_code}"><div class="font-semibold">${child.name}</div><div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Routes: ${formatServicingRoutes(child.servicing_routes, child.route_directions)}</div></div>`).join('')}</div>`;
                        suggestionsContainer.appendChild(groupEl);
                    } else {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-3 cursor-pointer suggestion-item border-b dark:border-gray-700';
                        itemEl.dataset.id = item.id;
                        itemEl.dataset.code = item.stop_code;
                        itemEl.innerHTML = `<div class="font-semibold">${item.name}</div><div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Routes: ${formatServicingRoutes(item.servicing_routes, item.route_directions)}</div>`;
                        suggestionsContainer.appendChild(itemEl);
                    }
                });
                suggestionsContainer.classList.remove('hidden');
            } else {
                suggestionsContainer.innerHTML = `<div class="p-3 text-center text-gray-500">No stops found.</div>`;
                suggestionsContainer.classList.remove('hidden');
            }
        }
        
        searchInput.addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            const query = searchInput.value.trim();
            if (query.length < 3) { suggestionsContainer.classList.add('hidden'); return; }
            searchDebounceTimer = setTimeout(() => {
                fetch(`${searchStopsEndpoint}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(stops => renderSuggestions(stops));
            }, 300);
        });

        suggestionsContainer.addEventListener('click', (e) => {
            const suggestionItem = e.target.closest('.suggestion-item');
            const parentToggle = e.target.closest('.parent-toggle');
            if (suggestionItem) {
                const stopCode = suggestionItem.dataset.code; 
                if (stopCode && !selectedStops.includes(stopCode)) {
                    selectedStops.push(stopCode);
                    renderSelectedStopTags();
                    fetchAndRenderDepartures();
                }
                searchInput.value = '';
                suggestionsContainer.classList.add('hidden');
            }
            if (parentToggle) {
                const childContainer = parentToggle.nextElementSibling;
                const icon = parentToggle.querySelector('.expand-icon');
                childContainer.classList.toggle('hidden');
                icon.textContent = childContainer.classList.contains('hidden') ? '+' : '‚àí';
            }
        });
        
        selectedStopsContainer.addEventListener('click', (e) => {
            if (e.target.matches('.remove-tag-btn')) {
                const stopCodeToRemove = e.target.dataset.code;
                selectedStops = selectedStops.filter(code => code !== stopCodeToRemove);
                renderSelectedStopTags();
                fetchAndRenderDepartures();
            }
        });

        findNearMeBtn.addEventListener('click', () => {
            if (!navigator.geolocation) { return alert('Geolocation is not supported by your browser.'); }
            findNearMeBtn.querySelector('span').textContent = 'Finding...';
            findNearMeBtn.disabled = true;
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    console.log(latitude,longitude);
                    fetch(`${findNearMeEndpoint}?lat=${latitude}&lon=${longitude}`)
                        .then(response => response.json())
                        .then(nearbyStops => {
                            if (nearbyStops.length > 0) {
                                renderSuggestions(nearbyStops);
                            } else {
                                alert('No stops found within a 500 meter radius.');
                            }
                        })
                        .finally(() => {
                            findNearMeBtn.querySelector('span').textContent = 'Near Me';
                            findNearMeBtn.disabled = false;
                        });
                },
                (error) => {
                    alert('Unable to retrieve your location. Please grant permission.');
                    findNearMeBtn.querySelector('span').textContent = 'Near Me';
                    findNearMeBtn.disabled = false;
                }
            );
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('section')) {
                suggestionsContainer.classList.add('hidden');
            }
        });

        updateCurrentTime();
        fetchAndRenderDepartures();
        setInterval(updateCurrentTime, 1000);
        setInterval(fetchAndRenderDepartures, 10000);
    </script>
</body>
</html>